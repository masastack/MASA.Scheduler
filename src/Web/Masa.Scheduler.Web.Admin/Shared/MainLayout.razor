@using Masa.Stack.Components.Models
@using Microsoft.AspNetCore.Components.Rendering
@inherits LayoutComponentBase
@inject GlobalConfig GlobalConfig
@inject NavigationManager Navigation

<Layout AppId="masa-scheduler-web-admin" OnSignOut="SignOut" OnErrorAsync="OnError" TeamRouteFormat="pages/team/{0}"
        Logo="https://cdn.masastack.com/stack/images/logo/MASAStack/logo-h-en.png"
        MiniLogo="/_content/Masa.Scheduler.Web.Admin/img/mainLayout/logo.svg">
    @Body
</Layout>

@code{
    [Inject]
    public IPopupService PopupService { get; set; } = default!;

    [Inject]
    public SchedulerServerCaller SchedulerServerCaller { get; set; } = default!;

    [Inject]
    private IJSRuntime Js { get; set; } = default!;

    private Task OnError(Exception exception)
    {
        PopupService.AlertAsync(exception.Message, AlertTypes.Error);
        GlobalConfig.Loading = false;
        return Task.CompletedTask;
    }

    private bool SignOut()
    {
        Navigation.NavigateTo("/Logout",true);
        return true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var timezoneMinuteOffset = await Js.InvokeAsync<long>("getTimezoneOffset");

            GlobalConfig.TimezoneOffset = TimeSpan.FromMinutes(-timezoneMinuteOffset);
        }
        await base.OnAfterRenderAsync(firstRender);
    }
}