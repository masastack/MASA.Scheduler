@using Masa.BuildingBlocks.StackSdks.Auth.Contracts;
@using Masa.Stack.Components.Models
@using Microsoft.AspNetCore.Components.Rendering
@inherits LayoutComponentBase
@inject GlobalConfig GlobalConfig
@inject Masa.Stack.Components.Configs.GlobalConfig StackGlobalConfig
@inject NavigationManager Navigation
@inject MasaUser MasaUser

<SLayout AppId="masa-scheduler-web-admin" OnSignOut="SignOut" OnErrorAsync="OnError" TeamRouteFormat="pages/team/{0}" WhiteUris="WhiteUris"
         Logo="https://cdn.masastack.com/stack/images/logo/MASAStack/logo-h-en.png"
         MiniLogo="/_content/Masa.Scheduler.Web.Admin/img/mainLayout/logo.svg" Exact="false">
    @Body
</SLayout>

@code {
    [Inject]
    public IPopupService PopupService { get; set; } = default!;

    [Inject]
    public SchedulerServerCaller SchedulerServerCaller { get; set; } = default!;

    [Inject]
    private IJSRuntime Js { get; set; } = default!;

    [Inject]
    private I18n i18n { get; set; } = default!;

    private List<string> WhiteUris = new List<string> { "pages/team/" };

    private Guid _teamId = default;

    private Task OnError(Exception exception)
    {
        PopupService.AlertAsync(i18n.T(exception.Message), AlertTypes.Error);
        GlobalConfig.Loading = false;
        return Task.CompletedTask;
    }

    private bool SignOut()
    {
        Navigation.NavigateTo("/Logout", true);
        return true;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (firstRender && MasaUser.CurrentTeamId != default)
        {
            SetTeamId(MasaUser.CurrentTeamId);
        }
    }

    protected override void OnInitialized()
    {
        StackGlobalConfig.OnCurrentTeamChanged += CurrentTeamChanged;
    }


    void CurrentTeamChanged(Guid teamId)
    {
        SetTeamId(teamId);
    }

    public void Dispose()
    {
        StackGlobalConfig.OnCurrentTeamChanged -= CurrentTeamChanged;
    }

    public void SetTeamId(Guid teamId)
    {
        if (_teamId != teamId)
        {
            _teamId = teamId;
            Navigation.NavigateTo($"/pages/team/{_teamId}");
        }
    }
}